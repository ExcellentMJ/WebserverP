<div class="my-5">
  <h1 class="text-center mb-3">댓글관리</h1>
  <div id="div_insert" style="display: none">
    <textarea id="txt_body" class="form-control" rows="5"></textarea>
    <div class="text-end mt-2">
      <button id="btn-insert" class="btn btn-primary btn-sm px-5">등록</button>
    </div>
  </div>
  <div id="div_login">
    <button class="btn btn-primary w-100">로그인</button>
  </div>
  <div>
    <div>댓글수: <span id="total"></span></div>
  </div>
  <div id="div_comments"></div>
</div>
<script id="temp_comments" type="x-handlebars-templates">
  {{#each .}}
    <div>
        <div>
            <small>{{email}}</small>
            <small>{{date}}</small>
        </div>
        <div>{{body}}</div>
    </div>
    <hr/>
  {{/each}}
</script>
<script type="module">
  // Firestore 사용
  import { app } from "/javascripts/firebaseInit.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    doc,
    where,
    orderBy,
    query,
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  const db = getFirestore(app);
  const pid = "<%=id%>";

  if (sessionStorage.getItem("email")) {
    $("#div_insert, #div_login").toggle();
  }

  $("#btn-login").on("click", function () {
    sessionStorage.setItem("target", "/posts/read?id=" + pid);
    location.href = "/users/login";
  });

  $("#btn-insert").on("click", async function () {
    const date = moment(new Date()).format("YYYY-MM-DD HH:mm:ss");
    const email = sessionStorage.getItem("email");
    const body = $("#txt_body").val();
    if (body == "") {
      alert("댓글 내용을 입력해");
      $("#txt_body").focus();
    } else {
      const data = { pid, email, date, body };
      await addDoc(collection(db, "comments"), data);
      $("#txt_body").val("");
      alert("저장 완료");
      getComments();
    }
  });
  getComments();
  async function getComments() {
    const q = query(
      collection(db, "comments"),
      where("pid", "==", pid),
      orderBy("date", "desc")
    );
    const snapshot = await getDocs(q);
    $("#total").html(snapshot.docs.length);
    // console.log(snapshot);
    let rows = [];
    snapshot.docs.forEach((doc) => {
      rows.push({ id: doc.id, ...doc.data() });
    });
    const temp = Handlebars.compile($("#temp_comments").html());
    $("#div_comments").html(temp(rows));
  }
</script>
